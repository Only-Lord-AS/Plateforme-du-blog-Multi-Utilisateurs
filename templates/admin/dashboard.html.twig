{% extends 'base.html.twig' %}

{% block title %}{{ 'admin.dashboard'|trans }}{% endblock %}

{% block body %}
<section class="page-section">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">
                    <i class="fas fa-chart-line"></i>
                    {{ 'admin.dashboard'|trans }}
                </h1>
                <p class="page-subtitle">{{ 'admin.statistics'|trans }}</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <a href="{{ path('admin_users', {'_locale': app.request.locale}) }}" class="stat-card stat-card-primary stat-card-link" data-aos="fade-up" data-aos-delay="100">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">{{ usersCount }}</h3>
                    <p class="stat-label">{{ 'admin.total_users'|trans }}</p>
                </div>
                <div class="stat-arrow"><i class="fas fa-chevron-right"></i></div>
            </a>
            
            <a href="{{ path('app_article_index', {'_locale': app.request.locale}) }}" class="stat-card stat-card-purple stat-card-link" data-aos="fade-up" data-aos-delay="200">
                <div class="stat-icon">
                    <i class="fas fa-newspaper"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">{{ articlesCount }}</h3>
                    <p class="stat-label">{{ 'admin.total_articles'|trans }}</p>
                </div>
                <div class="stat-arrow"><i class="fas fa-chevron-right"></i></div>
            </a>

            <!-- Total Comments -->
            <div class="stat-card stat-card-success" data-aos="fade-up" data-aos-delay="300">
                <div class="stat-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-value">{{ approvedComments + pendingComments + rejectedComments|default(0) }}</h3>
                    <p class="stat-label">{{ 'admin.total_comments'|trans }}</p>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mt-4">
            <!-- Pie Chart -->
            <div class="col-md-6" data-aos="fade-up" data-aos-delay="400">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-pie"></i>
                        {{ 'chart.comments_status'|trans }}
                    </h5>
                    <div class="chart-container">
                        <canvas id="commentsPie"></canvas>
                    </div>
                </div>
            </div>

            <!-- Line Chart -->
            <div class="col-md-6" data-aos="fade-up" data-aos-delay="500">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-line"></i>
                        {{ 'chart.platform_growth'|trans }}
                    </h5>
                    <div class="chart-container">
                        <canvas id="growthLine"></canvas>
                    </div>
                </div>
            </div>

            <!-- Bar Chart -->
            <div class="col-md-12" data-aos="fade-up" data-aos-delay="600">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-bar"></i>
                        {{ 'chart.global_stats'|trans }}
                    </h5>
                    <div class="chart-container chart-container-lg">
                        <canvas id="statsBar"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="{{ asset('assets/vendor/chart.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global Chart Settings
    Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    Chart.defaults.font.family = "'Inter', 'Segoe UI', sans-serif";

    // Translations
    const trans = {
        approved: "{{ 'chart.approved'|trans }}",
        pending: "{{ 'chart.pending'|trans }}",
        rejected: "{{ 'chart.rejected'|trans }}",
        noData: "{{ 'chart.no_data'|trans }}",
        totalCount: "{{ 'admin.statistics'|trans }}", 
        users: "{{ 'chart.users'|trans }}",
        articles: "{{ 'chart.articles'|trans }}"
    };

    /* 1. Comments Status (Pie Chart) */
    const approvedCount = {{ approvedComments }};
    const pendingCount = {{ pendingComments }};
    const rejectedCount = {{ rejectedComments|default(0) }};
    const totalComments = approvedCount + pendingCount + rejectedCount;

    let pieData = [approvedCount, pendingCount, rejectedCount];
    let pieColors = ['#22c55e', '#f59e0b', '#ef4444'];
    let pieLabels = [trans.approved, trans.pending, trans.rejected];

    // Handle Empty State
    if (totalComments === 0) {
        pieData = [1];
        pieColors = ['rgba(255, 255, 255, 0.1)'];
        pieLabels = [trans.noData];
    }

    new Chart(document.getElementById('commentsPie'), {
        type: 'doughnut',
        data: {
            labels: pieLabels,
            datasets: [{
                data: pieData,
                backgroundColor: pieColors,
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 20, font: { size: 12 } }
                },
                tooltip: {
                    enabled: totalComments > 0
                }
            },
            cutout: '65%'
        }
    });

    /* 2. Platform Growth (Line Chart) */
    fetch("{{ path('admin_dashboard_data') }}")
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('growthLine').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 242, 255, 0.5)');
            gradient.addColorStop(1, 'rgba(0, 242, 255, 0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: trans.users,
                        data: data.users,
                        borderColor: '#00f2ff',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        pointBackgroundColor: '#ffffff',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading chart data:', error));

    /* 3. Global Stats (Bar Chart) */
    new Chart(document.getElementById('statsBar'), {
        type: 'bar',
        data: {
            labels: [trans.users, trans.articles, trans.approved, trans.pending, trans.rejected],
            datasets: [{
                label: trans.totalCount,
                data: [{{ usersCount }}, {{ articlesCount }}, approvedCount, pendingCount, rejectedCount],
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(0, 242, 255, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    '#667eea',
                    '#00f2ff',
                    '#22c55e',
                    '#f59e0b',
                    '#ef4444'
                ],
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { stepSize: 1 }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
});
</script>
{% endblock %}